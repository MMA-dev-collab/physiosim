'use client';
import React, { useState, useRef, useEffect } from 'react';
import { Moon, Sun, Check, Copy, X } from 'lucide-react';

interface OTPInputProps {
    email: string;
    onVerify: (otp: string) => void;
    onResend: () => void;
    loading?: boolean;
    resendLoading?: boolean;
    error?: string | null;
    message?: string | null;
}

const OTPInput = ({
    email,
    onVerify,
    onResend,
    loading,
    resendLoading,
    error,
    message
}: OTPInputProps) => {
    const [otp, setOtp] = useState(['', '', '', '', '', '']);
    const [isDarkMode, setIsDarkMode] = useState(false);
    const [isPasted, setIsPasted] = useState(false);
    const [isComplete, setIsComplete] = useState(false);
    const inputRefs = useRef<(HTMLInputElement | null)[]>([]);

    useEffect(() => {
        const allFilled = otp.every(digit => digit !== '');
        setIsComplete(allFilled);
    }, [otp]);

    const handleChange = (index: number, value: string) => {
        // Only allow numbers
        if (value && !/^\d$/.test(value)) return;

        // Only allow single digit
        const char = value.slice(-1);

        const newOtp = [...otp];
        newOtp[index] = char;
        setOtp(newOtp);
        setIsPasted(false);

        // Auto focus next input
        if (char && index < 5) {
            inputRefs.current[index + 1]?.focus();
        }
    };

    const handleKeyDown = (index: number, e: React.KeyboardEvent<HTMLInputElement>) => {
        if (e.key === 'Backspace' && !otp[index] && index > 0) {
            // Move to previous input on backspace if current is empty
            inputRefs.current[index - 1]?.focus();
        } else if (e.key === 'ArrowLeft' && index > 0) {
            inputRefs.current[index - 1]?.focus();
        } else if (e.key === 'ArrowRight' && index < 5) {
            inputRefs.current[index + 1]?.focus();
        }
    };

    const handlePaste = (e: React.ClipboardEvent) => {
        e.preventDefault();
        const pastedData = e.clipboardData.getData('text').replace(/\D/g, '').slice(0, 6);

        if (pastedData.length > 0) {
            const newOtp = Array(6).fill('');
            for (let i = 0; i < Math.min(pastedData.length, 6); i++) {
                newOtp[i] = pastedData[i];
            }
            setOtp(newOtp);
            setIsPasted(true);

            // Focus the next empty input or the last one
            const nextEmptyIndex = newOtp.findIndex(digit => digit === '');
            const focusIndex = nextEmptyIndex === -1 ? 5 : nextEmptyIndex;
            setTimeout(() => inputRefs.current[focusIndex]?.focus(), 0);
        }
    };

    const clearOtp = () => {
        setOtp(['', '', '', '', '', '']);
        setIsPasted(false);
        setIsComplete(false);
        inputRefs.current[0]?.focus();
    };

    const copyOtp = () => {
        const otpString = otp.join('');
        navigator.clipboard.writeText(otpString);
    };

    const toggleTheme = () => {
        setIsDarkMode(!isDarkMode);
    };

    const themeClasses = {
        container: isDarkMode
            ? 'bg-gray-800 text-white'
            : 'bg-gray-100 text-gray-900',
        card: isDarkMode
            ? 'bg-gray-800 border-gray-800 '
            : 'bg-white border-gray-200 shadow-lg',
        input: isDarkMode
            ? 'bg-gray-700 border-gray-600 text-white focus:border-blue-400 focus:ring-blue-400'
            : 'bg-white border-gray-300 text-gray-900 focus:border-blue-500 focus:ring-blue-500',
        inputPasted: isDarkMode
            ? 'bg-green-800 border-green-600 text-green-100'
            : 'bg-green-50 border-green-400 text-green-800',
        inputComplete: isDarkMode
            ? 'bg-blue-800 border-blue-600 text-blue-100'
            : 'bg-blue-50 border-blue-400 text-blue-800',
        button: isDarkMode
            ? 'bg-blue-600 hover:bg-blue-700 text-white'
            : 'bg-blue-500 hover:bg-blue-600 text-white',
        buttonSecondary: isDarkMode
            ? 'bg-gray-600 hover:bg-gray-700 text-white border-gray-500'
            : 'bg-gray-100 hover:bg-gray-200 text-gray-700 border-gray-300',
        themeButton: isDarkMode
            ? 'bg-gray-700 hover:bg-gray-600 text-yellow-400'
            : 'bg-gray-200 hover:bg-gray-300 text-gray-600'
    };

    return (
        <div className={`${themeClasses.container} w-full p-8 flex flex-col items-center justify-center transition-colors duration-200 rounded-2xl`}>
            <div className="w-full">
                {/* Theme Toggle */}
                <div className="flex justify-end mb-4">
                    <button
                        type="button"
                        onClick={toggleTheme}
                        className={`${themeClasses.themeButton} p-2 rounded-lg transition-colors duration-200`}
                        aria-label="Toggle theme"
                    >
                        {isDarkMode ? <Sun size={20} /> : <Moon size={20} />}
                    </button>
                </div>

                {/* Main Card */}
                <div className={`${themeClasses.card} rounded-2xl border p-8 transition-colors duration-200`}>
                    <div className="text-center mb-8">
                        <h1 className="text-2xl font-bold mb-2">Enter Verification Code</h1>
                        <p className={`text-sm ${isDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                            We've sent a 6-digit code to <strong>{email}</strong>
                        </p>
                    </div>

                    {/* OTP Input Fields */}
                    <div className="flex justify-center gap-2 mb-6">
                        {otp.map((digit, index) => (
                            <input
                                key={index}
                                ref={(el) => { inputRefs.current[index] = el; }}
                                type="text"
                                value={digit}
                                onChange={(e) => handleChange(index, e.target.value)}
                                onKeyDown={(e) => handleKeyDown(index, e)}
                                onPaste={handlePaste}
                                className={`
                  w-10 h-12 sm:w-12 sm:h-14 text-center text-xl font-semibold rounded-lg border-2 transition-all duration-200
                  focus:outline-none focus:ring-2 focus:ring-offset-2
                  ${isPasted ? themeClasses.inputPasted :
                                        isComplete ? themeClasses.inputComplete :
                                            themeClasses.input}
                  ${isDarkMode ? 'focus:ring-offset-gray-800' : 'focus:ring-offset-white'}
                `}
                                maxLength={1}
                                autoComplete="off"
                            />
                        ))}
                    </div>

                    {/* Status Indicators */}
                    {(error || message || isPasted) && (
                        <div className="text-center mb-4 space-y-2">
                            {isPasted && !error && (
                                <span className={`inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-medium ${isDarkMode ? 'bg-green-800 text-green-200' : 'bg-green-100 text-green-700'
                                    }`}>
                                    <Check size={14} />
                                    Code pasted successfully
                                </span>
                            )}
                            {error && (
                                <div className="p-3 rounded-lg bg-red-50 text-red-600 border border-red-100 text-sm font-medium flex items-center justify-center gap-2">
                                    <X size={16} />
                                    {error}
                                </div>
                            )}
                            {message && (
                                <div className="p-3 rounded-lg bg-green-50 text-green-600 border border-green-100 text-sm font-medium flex items-center justify-center gap-2">
                                    <Check size={16} />
                                    {message}
                                </div>
                            )}
                        </div>
                    )}

                    {/* Action Buttons */}
                    <div className="space-y-3">
                        <button
                            type="button"
                            onClick={() => onVerify(otp.join(''))}
                            disabled={!isComplete || loading}
                            className={`
                w-full py-3 px-4 rounded-lg font-medium transition-all duration-200
                ${isComplete && !loading
                                    ? `${themeClasses.button} shadow-md transform hover:scale-[1.02]`
                                    : `${isDarkMode ? 'bg-gray-700 text-gray-400' : 'bg-gray-200 text-gray-400'} cursor-not-allowed`
                                }
              `}
                        >
                            {loading ? 'Verifying...' : 'Verify Code'}
                        </button>

                        <div className="flex gap-2">
                            <button
                                type="button"
                                onClick={clearOtp}
                                className={`flex-1 py-2 px-4 rounded-lg font-medium border transition-colors duration-200 ${themeClasses.buttonSecondary}`}
                            >
                                Clear
                            </button>

                            {isComplete && (
                                <button
                                    type="button"
                                    onClick={copyOtp}
                                    className={`px-4 py-2 rounded-lg transition-colors duration-200 ${themeClasses.buttonSecondary}`}
                                    title="Copy OTP"
                                >
                                    <Copy size={18} />
                                </button>
                            )}
                        </div>
                    </div>

                    {/* Help Text */}
                    <div className="mt-6 text-center">
                        <p className={`text-sm ${isDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                            Didn't receive the code?{' '}
                            <button
                                type="button"
                                onClick={onResend}
                                disabled={resendLoading}
                                className={`font-medium ${isDarkMode ? 'text-blue-400 hover:text-blue-300' : 'text-blue-600 hover:text-blue-500'} transition-colors disabled:opacity-50`}
                            >
                                {resendLoading ? 'Sending...' : 'Resend'}
                            </button>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    );
};

export default OTPInput;
